name: Mirror NASA Exoplanet Archive (daily)

on:
  workflow_dispatch:
  schedule:
    - cron: "10 2 * * *"

permissions:
  contents: write

concurrency:
  group: mirror-nasa-exoplanet-archive
  cancel-in-progress: false

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch upstream dataset (NASA Exoplanet Archive)
        env:
          NASA_SOURCE_URL: ${{ secrets.NASA_SOURCE_URL }}
        run: |
          set -euo pipefail
          if [ -z "${NASA_SOURCE_URL}" ]; then
            echo "NASA_SOURCE_URL secret is not set."
            exit 1
          fi

          mkdir -p public/data
          
          curl -L "${NASA_SOURCE_URL}"             -H "User-Agent: MCS-Education-Solar-Systems-Explorer (dataset mirror; contact: you@example.com)"             --fail --retry 5 --retry-delay 2             -o public/data/upstream.raw

          test -s public/data/upstream.raw

      - name: Normalize to JSON (supports JSON or CSV upstream)
        run: |
          set -euo pipefail

          OUT="public/data/nasa-exoplanet-archive-data.json"

          FIRST="$(python3 - <<'PY'
          import pathlib, re
          data = pathlib.Path("public/data/upstream.raw").read_bytes()
          m = re.search(rb'\S', data)
          print(chr(data[m.start()]) if m else "")
          PY
          )"
          if [ "$FIRST" = "{" ] || [ "$FIRST" = "[" ]; then
            cp public/data/upstream.raw "$OUT"
            echo "Upstream is JSON; copied to $OUT"
          else
            echo "Upstream not detected as JSON; attempting CSV->JSON conversion"
            python3 NASA_Data/scripts/convert_csv_to_json.py public/data/upstream.raw "$OUT"
          fi

          python3 - <<'PY'
          import json, pathlib
          p = pathlib.Path("public/data/nasa-exoplanet-archive-data.json")
          obj = json.loads(p.read_text("utf-8"))
          if not isinstance(obj, (list, dict)):
            raise SystemExit("Unexpected JSON top-level type: " + type(obj).__name__)
          print("JSON OK. Type:", type(obj).__name__, "Size bytes:", p.stat().st_size)
          PY

      - name: Build manifest.json
        env:
          NASA_SOURCE_URL: ${{ secrets.NASA_SOURCE_URL }}
        run: |
          set -euo pipefail
          OUT="public/data/nasa-exoplanet-archive-data.json"
          SHA256="$(sha256sum "$OUT" | awk '{print $1}')"
          GENERATED_AT="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

          cat > public/data/manifest.json <<EOF
          {
            "datasetName": "NASA Exoplanet Archive (mirrored by MCS)",
            "upstreamUrl": "${NASA_SOURCE_URL}",
            "generatedAt": "${GENERATED_AT}",
            "schemaVersion": 1,
            "sha256": "${SHA256}",
            "files": {
              "json": "nasa-exoplanet-archive-data.json"
            }
          }
          EOF

      - name: Deploy to GitHub Pages (gh-pages)
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: gh-pages
          force_orphan: true
